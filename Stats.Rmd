## Permutation tests
[Gamble et al. 2017](http://ac.els-cdn.com/S096098221730711X/1-s2.0-S096098221730711X-main.pdf?_tid=96291c02-972e-11e7-af1e-00000aacb35f&acdnat=1505161380_c7581d4fa26a658549dbc193e697af07) did permutations tests by resampling the sex of the individuals.

See [Jonathan's and Ben's course](https://mac-theobio.github.io/QMEE/permutation_examples.html) for some R commands.

The idea: comparing the number of sex linked sites we obtain from our family data with the distribution of "sex linked markers" obtained randomly shuffling the sex of the individuals. Should do it for "only 1 sex" site (I checked on a few with the HiSeq data and the de novo assemblies to see if the 2 set of data agrees for some it was not the case, we can see by similating a random generation of the data if our data are more likely not due to random/errors), sex specific SNP and globally.

Pratical idea: add a loop in the previous scripts to produce 100 different datasets and then plot the distribution of the number of "sex specific" sites. Should add a line corresponding to the number of XY and Zw sites. Then something like `2*mean(res>=obs)` to have a p-value. 

### Shuffling the ID files 
```R
setwd("~/Documents/caroline/linkage_try/qtl")
id <- read.table("Sample_ID.txt",sep="\t",h=T)
id

for (i in 1:1000) {
  id_1 <- transform( id, Sex = sample(Sex) )
  write.table(id_1, file = paste("Sample_ID_random_",i,".txt", sep=""), sep = "\t",quote=F,row.names =F)
}
```
Now we have the inputs for the other scripts. We need to add a loop to them and run them again in a separate folder. Previously run R to do 1000 permutations which created 1000 files. We will try everything with only 100 files 1st (to avoid having too many intermediary files). The number of permutations matter for the accuracy of the estimation of the p-value (Gamble et al. 2017 used 100 permutations). 

Recommendations from [Whashington University](http://faculty.washington.edu/kenrice/sisg/SISG-08-06.pdf)

*With 1000 permutations the smallest possible p-value is 0.001, and the uncertainty near p = 0.05  is about Â±1%*

So with 100 permutations the smallest possible p-value should be 0.01. We should probably try with 200 permutations so smallest p-value would be 0.005 which is good. 

### Changing the scripts

The easiest would probably to just call both of them within another one

`source_simulation.pl`
```perl
#!/usr/local/perl5.24/perl-5.24.0/perl

use strict;
use warnings;

## Argument for the perl scrip
my $output_path = $ARGV[0];
my $Genotype_file = $ARGV[1];
my $pedigree = $ARGV[2];
my $Sex_linked_sites = $output_path."\/Sex_linked";
my $Polym_sites = $output_path."\/Polym_sites";
my $Invalid_sites = $output_path."\/Invalid_sites";

## C++ 
my $count = $output_path."\/count_permutation.txt";
my $scaffold_number = $output_path."\/count_scaffolds_per_SD_system.txt";

## Other variables
my $commandline;
my $status;
my $y;

##Starting the loop
for ($y = 1 ; $y <= 200 ; $y++ ) {

##Calling the 1st perl script
	$commandline= "perl script_find_sex_linked_regions ".$Genotype_file." ".$pedigree."_".$y.".txt ".$Sex_linked_sites.$y." ".$Polym_sites.$y." ".$Invalid_sites.$y;
	$status = system($commandline);

##Calling the 2nd C++ script
	$commandline= "make makefile "; #to load the library and compile
	$status = system($commandline);
	$commandline= "./main.cpp ".$Sex_linked_sites.$y." ".$Polym_sites.$y." ".$Genotype_file." ".$count.$y" ".$scaffold_number." ".$y; 
        $status = system($commandline);

##Remove the intermediary files
	$commandline= "rm -f ".$Sex_linked_sites.$y." ".$Polym_sites.$y." ".$Invalid_sites.$y;
        $status = system($commandline); 
}
## should be able to just update for each value of i the outputs from the c++ script and only have 2 final files if yes we can directly do the 1000 permutations 
## if not we should concatenate the outputs of the script and again delete the intermediary files
## not final script: need to change the script_find_sex_linked_regions and the main.cpp to have the input and output files as arguments and also see if concatenation necessary
```
We should probabbly change the `count.txt` output since we do not need the scaffold names for the simulations.

Should only contain `number_total_called_genotype \t number_XY_sites \t Yonly \t number_ZW_sites \t Wonly \t number_polymorphic_dad_sites \t number_polymorphic_mom_sites \t number_polymorphic_daughter_sites \t number_polymorphic_son_sites`. 

For both outputs we should have the `i` value at the beginning of the line. 

Need to edit the `main.cpp` with `const char* sex_linked_file = arg[0]` and similar thing for the other files. 

Sept 15: Should be good to go: only need to uncomment the non necessary output files. I'll run also the `c++` simulation on the real data to have exactly the same outputs as the simulations. In order to not have a lot of intermediary or final files, for each permutation, the results will be append at the end of the outputfiles; so should be fine to run the 1000 permutations.
They will be run from `/4/caroline/random_simulation` by 

```
perl source_simulation.pl /4/caroline/random_simulation/pipa_simulation_SL /4/caroline/Pipa_parva/Rad_seq/GATK/SOAP_Chimerical_recalibrated_allsites_Phred20_HardFilteringSNP_filtered.tab /4/caroline/random_simulation/pipa_simulation_SL/Sample_ID_random
``` 
For each species, after the simulations, the input pedigree files will be compress to save space using:
```
tar -czvf pipa_sampleID_1000simulations.tar.gz /4/caroline/random_simulation/pipa_simulation_SL/Sample_ID_random*
``` 

