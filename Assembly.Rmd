# De novo assembly

Using the data corrected with `trimmomatic` & `Quake` ([see Starting](https://github.com/caro46/Hymenochirus/blob/master/Starting.Rmd)) 

## Abyss

To unload one module:
```
module unload intel mkl openmpi
```
To load other modules:
```
module load gcc/4.9.2
module load openmpi/gcc-4.9.2/std/1.8.7
module load boost/gcc492-openmpi187/1.59.0
```
```
export PATH=/work/ben/abyss/bin:$PATH
abyss-pe np=8 name=BJE3814 k=64 in='BJE3814_S3_L003_R1_001_trim_paired.cor.fastq.gz BJE3814_S3_L003_R2_001_trim_paired.cor.fastq.gz' 
```
Comments:

-Abyss for BJE3814 is finished: prepare the reference genome xenTro7 + BJE3814 as a reference for BJE3815. 

##To blast abyss outputs
On iqaluk: blast version `2.2.28+`.
Command to use after abyss:
```
module load blast/2.2.28+
```
## Format of blast output
|QueryID | SubjectID | % id | alignment length | mistmatches | gap openings | q.start | q.end | s.start | s.end | e-value | bit score| 
|---|---|---|---|---|---|---|---|---|---|---|---| 


###Prepare the reference
Need to `gunzip` the reference genome before making it blastable.
```
makeblastdb -in /work/ben/2016_Hymenochirus/xenTro7/xenTro7.fa.masked.gz -dbtype nucl -title UCSC_xenTro7 -out /work/ben/2016_Hymenochirus/xenTro7/xenTro7_genome_masked_blastable
```
BJE3814 for BJE3815
```
makeblastdb -in /work/ben/2016_Hymenochirus/BJE3814/BJE3814-8.fa -dbtype nucl -title Hymeno_Female_BJE3814 -out /work/ben/2016_Hymenochirus/BJE3814/BJE3814_genomeAbyss_blastable
```
###Blast the output of abyss (contigs) on *X. tropicalis* genome to identify putative sex-determining region ([female reference genome for *X. tropicalis*](http://www.ncbi.nlm.nih.gov/biosample/SAMN00000117)) 
```
blastn -evalue 1e-60 -query /work/ben/2016_Hymenochirus/BJE3814/BJE3814-8.fa -db /work/ben/2016_Hymenochirus/xenTro7/xenTro7_genome_masked_blastable -out /work/ben/2016_Hymenochirus/BJE3814/blast/BJE3814-8_xenTro7 -outfmt 6 -max_target_seqs 1
```
Check if contigs of our female (BJE3814) map to a region where our male (BJE3815) doesn't map.
Blast male de novo assambly against female and the opposite to find contigs only male or only female. Blast them against the female *X. tropicalis*.

##Blast Sox3 of *X. tropicalis* against both *de novo* assambly
[cDNA & coding region](http://useast.ensembl.org/Xenopus_tropicalis/Gene/Summary?db=core;g=ENSXETG00000007607;r=GL172698.1:1304016-1305642;t=ENSXETT00000016558) (coding region tend to be more conserved) and total gene because good match (NCBI Reference Sequence: NW_004668241.1 - XenTrop7)

```
blastn -evalue 1e-60 -query /work/ben/2016_Hymenochirus/BJE3814/blast/Xtropicalis_Sox3_cDNA.fa -db /work/ben/2016_Hymenochirus/BJE3814/BJE3814_genomeAbyss_blastable -out /work/ben/2016_Hymenochirus/BJE3814/blast/BJE3814-8_Sox3_cDNA -outfmt 6 -max_target_seqs 1

blastn -evalue 1e-60 -query /work/ben/2016_Hymenochirus/BJE3814/blast/Xtropicalis7_Sox3_gene_DNA.fa -db /work/ben/2016_Hymenochirus/BJE3814/BJE3814_genomeAbyss_blastable -out /work/ben/2016_Hymenochirus/BJE3814/blast/BJE3814-8_Sox3_gene -outfmt 6 -max_target_seqs 1

blastn -evalue 1e-60 -query /work/ben/2016_Hymenochirus/BJE3814/blast/Xtropicalis_ar_gene_DNA.fa -db /work/ben/2016_Hymenochirus/BJE3814/BJE3814_genomeAbyss_blastable -out /work/ben/2016_Hymenochirus/BJE3814/blast/BJE3814-8_xenTrop_ar_gene -outfmt 6 -max_target_seqs 1

blastn -evalue 1e-60 -query /work/ben/2016_Hymenochirus/BJE3814/blast/Xtropicalis_dmrta1_gene_DNA.fa -db /work/ben/2016_Hymenochirus/BJE3814/BJE3814_genomeAbyss_blastable -out /work/ben/2016_Hymenochirus/BJE3814/blast/BJE3814-8_xenTrop_dmrta1_gene -outfmt 6 -max_target_seqs 1

blastn -evalue 1e-60 -query /work/ben/2016_Hymenochirus/BJE3814/blast/Xtropicalis_dmrta2_gene_DNA.fa -db /work/ben/2016_Hymenochirus/BJE3814/BJE3814_genomeAbyss_blastable -out /work/ben/2016_Hymenochirus/BJE3814/blast/BJE3814-8_xenTrop_dmrta2_gene -outfmt 6 -max_target_seqs 1

blastn -evalue 1e-60 -query /work/ben/2016_Hymenochirus/BJE3814/blast/Bufo_dmrt1_genebank.fa -db /work/ben/2016_Hymenochirus/BJE3814/BJE3814_genomeAbyss_blastable -out /work/ben/2016_Hymenochirus/BJE3814/blast/BJE3814-8_Bufo_dmrt1 -outfmt 6 -max_target_seqs 1
```

See [Uno et al. 2008](http://www.ncbi.nlm.nih.gov/pubmed/18484182) for more sex-determining genes:  AR, SF-1/Ad4BP, Sox3, Dmrt1 (might not related to sex determination in *Rana rugosa*). And [Nakamura 2009](http://www.ncbi.nlm.nih.gov/pubmed/18996493): CYP19, CYP17, Foxl2.

> Compare size + identity of the blast results between male/female.

## Stampy (because Cortex not working for the moment)
```
/work/ben/stampy-1.0.28/stampy.py -t8 -g /work/ben/2016_Hymenochirus/xenTro7/xenTro7 -h /work/ben/2016_Hymenochirus/xenTro7/xenTro7 --substitutionrate=0.10 -o /work/ben/2016_Hymenochirus/BJE3814/BJE3814_stampy_xenTro7_paired.sam -M /work/ben/2016_Hymenochirus/BJE3814/BJE3814_S3_L003_R1_001_trim_paired.cor.fastq.gz /work/ben/2016_Hymenochirus/BJE3814/BJE3814_S3_L003_R2_001_trim_paired.cor.fastq.gz
```
Estimate coverage among the reference genome (samtools mpileup) + plot with `R`.

```
/work/ben/macaque_RAD_TAGs/samtools-0.1.18/samtools flagstat BJE3815_stampy_xenTro7_paired_sorted.bam > BJE3815_stampy_xenTro7_paired_sorted_flagstat.txt
```
Output from flagstat from BJE3815
```
87370213 + 0 in total (QC-passed reads + QC-failed reads)
0 + 0 duplicates
5278107 + 0 mapped (6.04%:-nan%)
87370213 + 0 paired in sequencing
43685107 + 0 read1
43685106 + 0 read2
1261700 + 0 properly paired (1.44%:-nan%)
2290444 + 0 with itself and mate mapped
2987663 + 0 singletons (3.42%:-nan%)
793302 + 0 with mate mapped to a different chr
121082 + 0 with mate mapped to a different chr (mapQ>=5)
```
Output from flagstat from BJE3814
```
102080926 + 0 in total (QC-passed reads + QC-failed reads)
0 + 0 duplicates
6247778 + 0 mapped (6.12%:-nan%)
102080926 + 0 paired in sequencing
51040463 + 0 read1
51040463 + 0 read2
1502320 + 0 properly paired (1.47%:-nan%)
2757848 + 0 with itself and mate mapped
3489930 + 0 singletons (3.42%:-nan%)
969546 + 0 with mate mapped to a different chr
144536 + 0 with mate mapped to a different chr (mapQ>=5)
```

> Results Stampy: bad mapping -> use bwa or bowtie to map male & female reads against Abyss genome (of both sex) and infer the coverage using Samtools 
